<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics</title>
    <style>
        /* Add your CSS styling here */
        .alert {
            padding: 10px;
            margin: 5px;
            color: white;
            border-radius: 5px;
        }
        .high-temp { background-color: red; }
        .high-pressure { background-color: orange; }
        .high-passenger { background-color: yellow; }
        .bus-buttons button {
            margin: 5px;
        }
    </style>
</head>
<body>
    <h1>Analytics</h1>
    <div id="alerts"></div>
    <div id="details" style="display: none;">
        <p id="driver-name">Driver Name: N/A</p>
        <p id="bus-number">Bus Number: N/A</p>
        <p id="first-arrival">First Arrival: N/A</p>
        <p id="last-arrival">Last Arrival: N/A</p>
        <p id="temp-value">Temperature: N/A</p>
        <p id="pressure-value">Pressure: N/A</p>
        <p id="passenger-value">Passenger Count: N/A</p>
    </div>
    <select id="metric-select" style="display: none;">
        <option value="temperature">Temperature</option>
        <option value="pressure">Pressure</option>
        <option value="passenger">Passenger Count</option>
    </select>
    <iframe id="graph-frame" style="width: 100%; height: 500px; border: none;"></iframe>
    <script>
        const UBIDOTS_TOKEN = 'BBUS-dbyhFn6DojMgw7k617dSgSdxy8NK7R';

        const BUS_VARIABLES = {
            1: {
                driverName: 'John Doe',
                busNumber: '101',
                firstArrival: '08:00 AM',
                lastArrival: '06:00 PM',
                temperature: '66b1bc61965f6723603b02a1',
                pressure: '66b1bc61ab9f8125f8ee7cf0',
                passenger: '66b1bc60cbbc7e27283a5c8d',
                metrics: {
                    temperature: 'https://ubidots.com/graphs/temperature?bus=1',
                    pressure: 'https://ubidots.com/graphs/pressure?bus=1',
                    passenger: 'https://ubidots.com/graphs/passenger?bus=1'
                }
            },
            // Repeat for buses 2 to 10
            // Add appropriate data for each bus
        };

        async function fetchData(variableId) {
            const response = await fetch(`https://industrial.api.ubidots.com/api/v1.6/variables/${variableId}/values?quantity=1`, {
                method: 'GET',
                headers: {
                    'X-Auth-Token': UBIDOTS_TOKEN,
                    'Content-Type': 'application/json'
                }
            });
            if (response.ok) {
                const data = await response.json();
                return data.results.map(result => result.value);
            } else {
                console.error('Failed to fetch data:', response.statusText);
                return [];
            }
        }

        async function updateAlerts() {
            try {
                const alertsDiv = document.getElementById('alerts');
                alertsDiv.innerHTML = ''; // Clear previous alerts

                for (const busId in BUS_VARIABLES) {
                    const busData = BUS_VARIABLES[busId];
                    const temperatureValues = await fetchData(busData.temperature);
                    const pressureValues = await fetchData(busData.pressure);
                    const passengerValues = await fetchData(busData.passenger);

                    // Check for alerts
                    if (temperatureValues[0] > 50) {
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert high-temp';
                        alertDiv.textContent = `Bus ${busId} High Temperature Detected: ${temperatureValues[0]} °C`;
                        alertsDiv.appendChild(alertDiv);
                    }
                    if (pressureValues[0] > 6) {
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert high-pressure';
                        alertDiv.textContent = `Bus ${busId} Potential Pipe Leak: High Pressure Detected (${pressureValues[0]} bar)`;
                        alertsDiv.appendChild(alertDiv);
                    }
                    if (passengerValues[0] > 100) {
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert high-passenger';
                        alertDiv.textContent = `Bus ${busId} High Passenger Count Detected: ${passengerValues[0]}`;
                        alertsDiv.appendChild(alertDiv);
                    }
                }
            } catch (error) {
                console.error('Error updating alerts:', error);
            }
        }

        async function updateDashboard(busId) {
            try {
                const busData = BUS_VARIABLES[busId];
                if (busData) {
                    // Update driver and bus details
                    document.getElementById('driver-name').textContent = `Driver Name: ${busData.driverName}`;
                    document.getElementById('bus-number').textContent = `Bus Number: ${busData.busNumber}`;
                    document.getElementById('first-arrival').textContent = `First Arrival: ${busData.firstArrival}`;
                    document.getElementById('last-arrival').textContent = `Last Arrival: ${busData.lastArrival}`;

                    // Fetch values for the selected bus
                    const temperatureValues = await fetchData(busData.temperature);
                    const pressureValues = await fetchData(busData.pressure);
                    const passengerValues = await fetchData(busData.passenger);

                    // Update final values
                    document.getElementById('temp-value').textContent = `Temperature: ${temperatureValues[0]} °C`;
                    document.getElementById('pressure-value').textContent = `Pressure: ${pressureValues[0]} bar`;
                    document.getElementById('passenger-value').textContent = `Passenger Count: ${passengerValues[0]}`;

                    // Handle dropdown change
                    document.getElementById('metric-select').addEventListener('change', function() {
                        const metric = this.value;
                        if (busData.metrics[metric]) {
                            document.getElementById('graph-frame').src = busData.metrics[metric];
                        }
                    });

                    // Show dropdown
                    document.getElementById('metric-select').style.display = 'block';

                } else {
                    console.error('Bus data not found');
                }
            } catch (error) {
                console.error('Error updating dashboard:', error);
            }
        }

        // Initialize alerts and dashboard
        updateAlerts();
        document.querySelectorAll('.bus-buttons button').forEach(button => {
            button.addEventListener('click', function() {
                const busId = this.getAttribute('data-bus');
                updateDashboard(busId);
            });
        });
    </script>
</body>
</html>
